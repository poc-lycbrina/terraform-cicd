name: Terraform CI/CD Entry Point

on:
  pull_request:
    branches:
      - dev
      - main
  push:
    branches:
      - dev
      - main

  workflow_dispatch:
    inputs:
      workflow:
        description: "Select workflow to run"
        required: true
        type: choice
        options:
          - unlock-state
          - destroy-terraform 
      environment:
        description: "Select environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - uat
          - prod

jobs:      

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-dev: ${{ steps.set.outputs.changed-dev }}
      changed-uat: ${{ steps.set.outputs.changed-uat }}
      changed-prod: ${{ steps.set.outputs.changed-prod }}
      trigger-all: ${{ steps.set.outputs.trigger-all }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: set
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=50 || true
          CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED"

          echo "$CHANGED" | grep 'dev' >/dev/null && echo "changed-dev=true" >> $GITHUB_OUTPUT || echo "changed-dev=false" >> $GITHUB_OUTPUT
          echo "$CHANGED" | grep 'uat' >/dev/null && echo "changed-uat=true" >> $GITHUB_OUTPUT || echo "changed-uat=false" >> $GITHUB_OUTPUT
          echo "$CHANGED" | grep 'prod' >/dev/null && echo "changed-prod=true" >> $GITHUB_OUTPUT || echo "changed-prod=false" >> $GITHUB_OUTPUT

          ONLY_SHARED=$(echo "$CHANGED" | grep -Ev 'dev|uat|prod' || true)
          echo "$CHANGED" | grep -Ev 'dev|uat|prod' || true
          NO_ENV=$(echo "$CHANGED" | grep -Ev 'dev|uat|prod' || true)

          if [ -n "$ONLY_SHARED" ] && [ "$(echo "$CHANGED" | grep -E 'dev|uat|prod' | wc -l)" -eq 0 ]; then
            echo "trigger-all=true" >> $GITHUB_OUTPUT
          else
            echo "trigger-all=false" >> $GITHUB_OUTPUT
          fi

  # PR to DEV branch
  pr-dev:
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' && github.base_ref == 'dev' 
      && (needs.detect-changes.outputs.changed-dev == 'true' || needs.detect-changes.outputs.trigger-all == 'true')
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: dev
      tfvars: terraform.dev.tfvars
      opa_check: true
      backend_config: backend.dev.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  # Push to DEV
  push-dev-plan:
    needs: detect-changes
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/dev' 
      && (needs.detect-changes.outputs.changed-dev == 'true' || needs.detect-changes.outputs.trigger-all == 'true')
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: dev
      tfvars: terraform.dev.tfvars
      backend_config: backend.dev.hcl
      apply: true
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  push-dev-apply:
    needs: push-dev-plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: dev
      tfvars: terraform.dev.tfvars
      apply: true
      backend_config: backend.dev.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  # PR from DEV to MAIN
  pr-main-uat:
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'dev'
      && (needs.detect-changes.outputs.changed-uat == 'true' || needs.detect-changes.outputs.trigger-all == 'true')    
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: uat
      tfvars: terraform.uat.tfvars
      opa_check: true
      backend_config: backend.uat.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  pr-main-prod:
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'dev'
      && (needs.detect-changes.outputs.changed-prod == 'true' || needs.detect-changes.outputs.trigger-all == 'true')  
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: prod
      tfvars: terraform.prod.tfvars
      opa_check: true
      backend_config: backend.prod.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  # Push to MAIN (merge)
  main-uat-plan:
    needs: detect-changes
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main'
      && (needs.detect-changes.outputs.changed-uat == 'true' || needs.detect-changes.outputs.trigger-all == 'true')    
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: uat
      tfvars: terraform.uat.tfvars
      backend_config: backend.uat.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  main-uat-apply:
    needs: main-uat-plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: uat
      tfvars: terraform.uat.tfvars
      apply: true
      backend_config: backend.uat.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  main-prod-plan:
    needs: main-uat-apply
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main'
      && (needs.detect-changes.outputs.changed-prod == 'true' || needs.detect-changes.outputs.trigger-all == 'true') 
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: prod
      tfvars: terraform.prod.tfvars
      backend_config: backend.prod.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  main-prod-apply:
    needs: main-prod-plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      environment: prod
      tfvars: terraform.prod.tfvars
      apply: true
      backend_config: backend.prod.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7


  # Destroy plan for DEV
  destroy-plan-dev:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev'  && github.event.inputs.workflow == 'destroy-terraform'
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: dev
      tfvars: terraform.dev.tfvars
      backend_config: backend.dev.hcl
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7

  # Unlock plan for DEV
  unlock-state-dev:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev'  && github.event.inputs.workflow == 'unlock-state'
    uses: ./.github/workflows/terraform-state-unlock.yml
    with:
      environment: dev
      IAM_OIDC_ROLE: arn:aws:iam::140023376669:role/cmrs-DEV-TH-custom-GithubOIDCRole
      REGION: ap-southeast-7
      STATE_S3_BUCKET: terraform-state-140023376669